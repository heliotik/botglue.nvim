# Design: UI/UX Improvements botglue.nvim v0.2.1

## Overview

Seven UI/UX improvements to the three-panel picker interface. All changes are confined to `picker.lua` and `ui.lua`. No changes to `config.lua`, `history.lua`, `display.lua`, `operations.lua`, `claude.lua`, or `init.lua`.

## Current State

Three independent float windows with individual `border = "rounded"`:
- Panel 1 (Filter): single-line fuzzy filter input
- Panel 2 (List): history entries sorted by frequency, each line = prompt text + `[model]` tag with manual padding
- Panel 3 (Prompt): multi-line editor with model badge footer

Active panel highlighted via `BotglueActiveBorder` (yellow border). Navigation: `Tab` cycles panels, `/` focuses filter, `Enter` selects from list, `Ctrl+S` submits.

## Design

### 1. Container Frame with "BotGlue" Title

Replace individual panel borders with a single unified container.

**Container window:** non-focusable float (`focusable = false`) with `border = "rounded"`, `title = " BotGlue "`, `title_pos = "center"`. Its buffer holds divider lines at the correct rows. The model badge `[opus]` moves to the container's `footer` / `footer_pos = "right"`.

**Full layout** (container interior height = `1 + 1 + list_h + 1 + 5 = list_h + 8`):

```
╭──────────── BotGlue ─────────────╮
│ [filter input - 1 row]           │  ← row 0
│── Recent prompts ─────────────── │  ← row 1 (divider in container buf)
│ prompt 1                 [opus]  │  ← row 2
│ prompt 2               [sonnet]  │  ← ...
│ prompt N                 [opus]  │  ← row 1+list_h
│── Prompt ─────────────────────── │  ← row 2+list_h (divider in container buf)
│                                  │  ← row 3+list_h
│ [prompt editor - 5 rows]        │
│                                  │
╰──────────────────────── [opus] ──╯
```

Inner panels use `border = "none"`, positioned at exact rows inside the container. Divider text is visible because no inner panel overlaps those rows.

**Prompt-only layout:** same container with `title = " BotGlue "` and model footer, height = 5. No dividers, just the prompt editor inside.

**Model cycling** (`<S-Tab>`) updates the container's footer via `nvim_win_set_config`.

**Active panel indication:** `BotglueActiveBorder` highlight applied to the container window's border is always active (it's the outer frame). Individual panel focus is indicated by `cursorline` in list and cursor visibility in filter/prompt — no per-panel border highlight changes needed since panels have no borders.

**`close_all()`** updated to also close the container window.

### 2. Divider Labels on Separator Lines

Dividers are lines in the container buffer at the rows between panels:
- Row 1: `"── Recent prompts "` padded with `─` to full width
- Row `2 + list_h`: `"── Prompt "` padded with `─` to full width

Labels name the section **below** the divider. The filter section at the top is self-evident (under "BotGlue" title).

Divider highlight: `FloatBorder` group for visual consistency with the container border.

### 3. Disable Autocomplete in All Panels

For every panel buffer (`filter_buf`, `list_buf`, `prompt_handle.buf`):

```lua
vim.bo[buf].buftype = "nofile"
vim.bo[buf].completefunc = ""
vim.bo[buf].omnifunc = ""
vim.bo[buf].complete = ""
vim.b[buf].cmp = false  -- nvim-cmp integration
```

Applied in `_open_full()` for filter and list buffers, and in `ui.create_prompt_window()` for the prompt buffer.

### 4. Model Tag as Right-Aligned Extmark

In `render_list()`, each list line contains only the prompt text with `"  "` left padding. The `[model]` tag is rendered via:

```lua
nvim_buf_set_extmark(list_buf, ns, line_idx, 0, {
  virt_text = { { "[" .. entry.model .. "]", "Comment" } },
  virt_text_pos = "right_align",
})
```

This eliminates the padding calculation (`string.rep(" ", padding)`) and the model tag from the line string entirely.

### 5. UTF-8 Safe Truncation

With model tags removed from lines, truncation logic simplifies:

```lua
local display_w = vim.fn.strdisplaywidth(prompt_text)
local available = container_inner_width - 2  -- left padding
if display_w > available then
  prompt_text = vim.fn.strcharpart(prompt_text, 0, available - 1) .. "…"
end
```

Uses `strdisplaywidth` for width measurement and `strcharpart` for character-aware substring instead of byte-based `string.sub` and `#string`.

### 6. Fuzzy Match Highlights

Replace `vim.fn.matchfuzzy` with `vim.fn.matchfuzzypos` in `apply_filter()`:

```lua
local result = vim.fn.matchfuzzypos(prompts, text)
-- result[1] = matched strings, result[2] = positions per match, result[3] = scores
```

Pass positions to `render_list()`. Apply per-character highlights via `nvim_buf_add_highlight` using namespace `botglue_filter_hl` and `Search` highlight group. Positions from `matchfuzzypos` are byte-indexed on original prompt strings — offset by 2 bytes (the `"  "` left padding) when applying to buffer lines.

Clear the namespace before each render cycle.

### 7. Filter Placeholder

Extmark with `virt_text_pos = "overlay"` at row 0, col 0 in `filter_buf`:

```lua
nvim_buf_set_extmark(filter_buf, placeholder_ns, 0, 0, {
  virt_text = { { "Filter recent prompts - press / to focus", "Comment" } },
  virt_text_pos = "overlay",
})
```

Managed in `apply_filter()` — cleared when filter text is non-empty, restored when empty. Reuses the existing `TextChangedI` autocmd.

### 8. Close UI on Focus Loss

`WinLeave` autocmd on all panel buffers. Callback uses `vim.schedule` (so current window has updated), then checks if `nvim_get_current_win()` is any of `filter_win`, `list_win`, `prompt_handle.win`, or `container_win`. If not — calls `close_all()`.

Same pattern for `_open_prompt_only` (container + prompt windows).

```lua
vim.api.nvim_create_autocmd("WinLeave", {
  buffer = buf,
  callback = function()
    if closed then return end
    vim.schedule(function()
      if closed then return end
      local cur = vim.api.nvim_get_current_win()
      if cur ~= filter_win and cur ~= list_win
         and cur ~= prompt_handle.win and cur ~= container_win then
        close_all()
      end
    end)
  end,
})
```

## Implementation Order

| Step | Task | Depends On |
|------|------|------------|
| 1 | Container frame + divider labels (tasks 1-2) | — |
| 2 | Disable autocomplete (task 3) | step 1 (needs buffer refs) |
| 3 | Model tag as extmark (task 4) | step 1 (render_list context) |
| 4 | UTF-8 truncation fix (task 5) | step 3 (simplified by extmark) |
| 5 | Fuzzy match highlights (task 6) | step 4 (render_list format) |
| 6 | Close on focus loss (task 7) | step 1 (needs window refs) |
| 7 | Filter placeholder (task 8) | step 1 (needs filter_buf) |

Steps 2, 6, 7 are independent after step 1 and can be done in parallel. Steps 3-4-5 are sequential.

## Files Changed

- **`lua/botglue/picker.lua`** — all tasks: container window, layout math, render_list overhaul, autocmds, keymaps, autocomplete, placeholder
- **`lua/botglue/ui.lua`** — task 3 (autocomplete settings on prompt buf), footer removal (model badge moves to container)

## Testing Notes

- Container window and dividers cannot be tested in headless mode (`nvim_list_uis()` is empty) — manual verification required
- `render_list` changes (extmarks, truncation, highlights) can be unit tested via buffer inspection
- `matchfuzzypos` positions can be tested with known inputs
- Autocomplete settings can be verified via `vim.bo` assertions
