# v0.2.0 Bugfix Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix two critical bugs — result parsing (never inserts text) and parallel request support (blocks concurrent requests) — and remove cancel functionality.

**Architecture:** Rewrite `_extract_result()` and `on_stdout` to match the real Claude Code CLI `stream-json` format. Refactor `claude.start()` to return per-request handles instead of using module-level singletons, enabling multiple concurrent requests. Remove all cancel-related code from `claude.lua`, `operations.lua`, and `init.lua`.

**Tech Stack:** Lua, Neovim API (`vim.fn.jobstart`, `vim.uv.new_timer`), plenary.nvim for tests

**Design doc:** `docs/plans/2026-02-07-v0.2.0-bugfix-design.md`

---

## Background: Real Claude Code CLI stream-json format

The CLI command `claude -p "..." --output-format stream-json --verbose` emits one JSON object per line:

```json
{"type":"system","subtype":"init",...}
{"type":"assistant","message":{"content":[{"type":"text","text":"Hi!"}],...}}
{"type":"assistant","message":{"content":[{"type":"tool_use","name":"Read","input":{...}}],...}}
{"type":"user","message":{"content":[{"tool_use_id":"...","type":"tool_result",...}],...}}
{"type":"result","subtype":"success","result":"final text here",...}
```

Key event types:
- `type == "assistant"` with `message.content[]` array — contains `{type:"text",text:"..."}` and `{type:"tool_use",name:"..."}` blocks
- `type == "result"` with `result` string field — final result summary
- `type == "system"` — init, hooks — ignore these
- `type == "user"` — tool results — ignore these

---

### Task 1: Rewrite `_extract_result()` tests for real CLI format

**Files:**
- Modify: `test/botglue/claude_spec.lua:78-131`

**Step 1: Replace the `_extract_result` test block**

Replace the entire `describe("_extract_result", ...)` block (lines 78-131) with tests matching the real CLI format:

```lua
  describe("_extract_result", function()
    it("returns nil for empty chunks", function()
      assert.is_nil(claude._extract_result({}))
    end)

    it("extracts result from type=result line", function()
      local chunks = {
        vim.json.encode({ type = "system", subtype = "init" }),
        vim.json.encode({
          type = "result",
          subtype = "success",
          result = "the answer",
        }),
      }
      assert.equals("the answer", claude._extract_result(chunks))
    end)

    it("accumulates text from assistant messages", function()
      local chunks = {
        vim.json.encode({
          type = "assistant",
          message = {
            content = { { type = "text", text = "hello " } },
          },
        }),
        vim.json.encode({
          type = "assistant",
          message = {
            content = { { type = "text", text = "world" } },
          },
        }),
      }
      assert.equals("hello world", claude._extract_result(chunks))
    end)

    it("prefers type=result over accumulated assistant text", function()
      local chunks = {
        vim.json.encode({
          type = "assistant",
          message = {
            content = { { type = "text", text = "partial" } },
          },
        }),
        vim.json.encode({
          type = "result",
          subtype = "success",
          result = "final result",
        }),
      }
      assert.equals("final result", claude._extract_result(chunks))
    end)

    it("ignores tool_use blocks in assistant messages", function()
      local chunks = {
        vim.json.encode({
          type = "assistant",
          message = {
            content = {
              { type = "text", text = "code here" },
              { type = "tool_use", name = "Read", input = {} },
            },
          },
        }),
      }
      assert.equals("code here", claude._extract_result(chunks))
    end)

    it("ignores system and user events", function()
      local chunks = {
        vim.json.encode({ type = "system", subtype = "init" }),
        vim.json.encode({
          type = "user",
          message = { content = { { type = "tool_result" } } },
        }),
      }
      assert.is_nil(claude._extract_result(chunks))
    end)

    it("ignores invalid JSON chunks", function()
      local chunks = {
        "not json at all",
        vim.json.encode({
          type = "result",
          subtype = "success",
          result = "valid result",
        }),
        "more garbage",
      }
      assert.equals("valid result", claude._extract_result(chunks))
    end)

    it("returns nil when no result found", function()
      local chunks = {
        vim.json.encode({ type = "system", subtype = "init" }),
      }
      assert.is_nil(claude._extract_result(chunks))
    end)
  end)
```

**Step 2: Run test to verify it fails**

Run: `nvim --headless -u test/minimal_init.lua -c "PlenaryBustedFile test/botglue/claude_spec.lua"`

Expected: Several tests FAIL because `_extract_result()` still uses the old `stream_event`/`text_delta` parsing. Specifically:
- "extracts result from type=result line" — might pass (old `parsed.result` check catches it)
- "accumulates text from assistant messages" — FAIL (old code checks `stream_event`, not `assistant`)
- "ignores tool_use blocks" — FAIL
- Others may pass or fail depending on old logic

**Step 3: Commit**

```bash
git add test/botglue/claude_spec.lua
git commit -m "test(claude): rewrite _extract_result tests for real CLI stream-json format"
```

---

### Task 2: Fix `_extract_result()` implementation

**Files:**
- Modify: `lua/botglue/claude.lua:137-162`

**Step 1: Replace `_extract_result` function**

Replace lines 137-162 in `lua/botglue/claude.lua` with:

```lua
function M._extract_result(chunks)
  local result_parts = {}

  for _, chunk in ipairs(chunks) do
    local ok, parsed = pcall(vim.json.decode, chunk)
    if ok and parsed then
      if parsed.type == "result" and parsed.result then
        return parsed.result
      end
      if parsed.type == "assistant" and parsed.message and parsed.message.content then
        for _, block in ipairs(parsed.message.content) do
          if block.type == "text" and block.text then
            table.insert(result_parts, block.text)
          end
        end
      end
    end
  end

  if #result_parts > 0 then
    return table.concat(result_parts, "")
  end

  return nil
end
```

**Step 2: Run tests to verify they pass**

Run: `nvim --headless -u test/minimal_init.lua -c "PlenaryBustedFile test/botglue/claude_spec.lua"`

Expected: All `_extract_result` tests PASS.

**Step 3: Commit**

```bash
git add lua/botglue/claude.lua
git commit -m "fix(claude): rewrite _extract_result to match real CLI stream-json format"
```

---

### Task 3: Remove cancel from `claude.lua`

**Files:**
- Modify: `lua/botglue/claude.lua:5-7` (module state), `164-195` (cancel + timeout functions)
- Modify: `test/botglue/claude_spec.lua:133-139` (cancel test)

**Step 1: Delete module-level state variables**

Remove lines 5-7 from `lua/botglue/claude.lua`:

```lua
M._active_job = nil
M._timeout_timer = nil
M._cancel_reason = nil
```

**Step 2: Delete `M.cancel()` function**

Remove lines 164-171 from `lua/botglue/claude.lua`:

```lua
function M.cancel()
  M._cancel_reason = M._cancel_reason or "cancelled"
  if M._active_job and M._active_job > 0 then
    vim.fn.jobstop(M._active_job)
    M._active_job = nil
  end
  M._clear_timeout()
end
```

**Step 3: Delete `M._start_timeout()` and `M._clear_timeout()`**

Remove lines 173-195 from `lua/botglue/claude.lua`:

```lua
function M._start_timeout(timeout_sec)
  ...
end

function M._clear_timeout()
  ...
end
```

**Step 4: Delete the cancel test block**

Remove lines 133-139 from `test/botglue/claude_spec.lua`:

```lua
  describe("cancel", function()
    it("does not error when no active job", function()
      assert.has_no.errors(function()
        claude.cancel()
      end)
    end)
  end)
```

**Step 5: Run tests**

Run: `nvim --headless -u test/minimal_init.lua -c "PlenaryBustedFile test/botglue/claude_spec.lua"`

Expected: All remaining tests PASS. The `build_command`, `build_system_prompt`, and `_extract_result` tests should be unaffected.

**Step 6: Commit**

```bash
git add lua/botglue/claude.lua test/botglue/claude_spec.lua
git commit -m "refactor(claude): remove cancel and module-level state"
```

---

### Task 4: Refactor `claude.start()` to return per-request handle

**Files:**
- Modify: `lua/botglue/claude.lua:54-132`

**Step 1: Rewrite `start()` function**

Replace the entire `M.start()` function (lines 54-132) with:

```lua
--- Start a Claude Code request.
--- @param prompt string
--- @param ctx table
--- @param observer table {on_stdout: fn(parsed), on_complete: fn(err, result)}
--- @return table handle {job_id: number}
function M.start(prompt, ctx, observer)
  local cmd = M.build_command(prompt, ctx)
  local stdout_chunks = {}
  local partial = ""
  local handle = {}

  local function clear_timeout()
    if handle.timeout_timer then
      handle.timeout_timer:stop()
      handle.timeout_timer:close()
      handle.timeout_timer = nil
    end
  end

  handle.job_id = vim.fn.jobstart(cmd, {
    stdout_buffered = false,
    stderr_buffered = false,
    on_stdout = function(_, data)
      if not data then
        return
      end
      data[1] = partial .. data[1]
      partial = data[#data]
      for i = 1, #data - 1 do
        local line = data[i]
        if line ~= "" then
          table.insert(stdout_chunks, line)
          local ok, parsed = pcall(vim.json.decode, line)
          if ok and parsed then
            if observer.on_stdout then
              observer.on_stdout(parsed)
            end
          end
        end
      end
    end,
    on_stderr = function() end,
    on_exit = function(_, code)
      clear_timeout()
      handle.job_id = nil

      if code ~= 0 then
        vim.schedule(function()
          observer.on_complete("Claude Code exited with code " .. code, nil)
        end)
        return
      end

      vim.schedule(function()
        local result = M._extract_result(stdout_chunks)
        if result and result ~= "" then
          observer.on_complete(nil, result)
        else
          observer.on_complete("Empty response from Claude", nil)
        end
      end)
    end,
  })

  if handle.job_id <= 0 then
    handle.job_id = nil
    observer.on_complete("Failed to start Claude process", nil)
    return handle
  end

  handle.timeout_timer = vim.uv.new_timer()
  handle.timeout_timer:start(
    config.options.timeout * 1000,
    0,
    vim.schedule_wrap(function()
      if handle.job_id then
        vim.fn.jobstop(handle.job_id)
      end
      clear_timeout()
    end)
  )

  return handle
end
```

Key changes from old code:
- No `M._active_job`, no `M._cancel_reason`, no `M._timeout_timer`
- No guard "Another request is already running"
- `clear_timeout()` is local to this invocation
- `handle` table holds per-request `job_id` and `timeout_timer`
- Returns `handle`
- Timeout just stops the job — `on_exit` fires with non-zero code, reports error

**Step 2: Run tests**

Run: `nvim --headless -u test/minimal_init.lua -c "PlenaryBustedFile test/botglue/claude_spec.lua"`

Expected: All `build_command`, `build_system_prompt`, and `_extract_result` tests still PASS. (`start()` is not directly tested in `claude_spec.lua` — it's tested via `operations_spec.lua` mocks.)

**Step 3: Commit**

```bash
git add lua/botglue/claude.lua
git commit -m "refactor(claude): start() returns per-request handle, enables parallel requests"
```

---

### Task 5: Remove cancel from `operations.lua` and `init.lua`

**Files:**
- Modify: `lua/botglue/operations.lua:108-109` (M._cleanup), `150-157` (cancel function)
- Modify: `lua/botglue/init.lua:17-19` (cancel keymap), `51-53` (cancel function)

**Step 1: Remove `M._cleanup` assignment in `operations.lua`**

Delete line 108-109 from `lua/botglue/operations.lua`:

```lua
  -- Store cleanup for external cancel
  M._cleanup = cleanup
```

**Step 2: Remove `M.cancel()` from `operations.lua`**

Delete lines 150-157 from `lua/botglue/operations.lua`:

```lua
function M.cancel()
  claude.cancel()
  if M._cleanup then
    M._cleanup()
    M._cleanup = nil
  end
  vim.notify("botglue: cancelled", vim.log.levels.WARN)
end
```

**Step 3: Remove cancel keymap from `init.lua`**

Delete lines 17-19 from `lua/botglue/init.lua`:

```lua
    vim.keymap.set("x", "<leader>ps", function()
      M.cancel()
    end, { desc = "Botglue: cancel", silent = true })
```

**Step 4: Remove `M.cancel()` from `init.lua`**

Delete lines 51-53 from `lua/botglue/init.lua`:

```lua
function M.cancel()
  operations.cancel()
end
```

**Step 5: Run all tests**

Run: `make test`

Expected: `operations_spec.lua` cancel tests will FAIL because `operations.cancel` no longer exists. That's expected — we'll fix the tests in the next task.

**Step 6: Commit**

```bash
git add lua/botglue/operations.lua lua/botglue/init.lua
git commit -m "refactor: remove cancel functionality from operations and init"
```

---

### Task 6: Fix `on_stdout` parsing in `operations.lua`

**Files:**
- Modify: `lua/botglue/operations.lua:128-136`

**Step 1: Replace the `on_stdout` callback**

Replace the `on_stdout` callback in `operations.lua` (currently lines 129-135 inside the `claude.start()` call):

Old:
```lua
    on_stdout = function(parsed)
      if parsed.type == "stream_event" and parsed.event then
        local delta = parsed.event.delta
        if delta and delta.type == "tool_use" then
          top_status:push("Using " .. (delta.name or "tool") .. "...")
        end
      end
    end,
```

New:
```lua
    on_stdout = function(parsed)
      if parsed.type == "assistant" and parsed.message and parsed.message.content then
        for _, block in ipairs(parsed.message.content) do
          if block.type == "tool_use" and block.name then
            top_status:push("Using " .. block.name .. "...")
          end
        end
      end
    end,
```

**Step 2: Run tests**

Run: `nvim --headless -u test/minimal_init.lua -c "PlenaryBustedFile test/botglue/operations_spec.lua"`

Expected: `run` tests PASS, `cancel` tests FAIL (cancel code was deleted in Task 5). Next task fixes tests.

**Step 3: Commit**

```bash
git add lua/botglue/operations.lua
git commit -m "fix(operations): on_stdout parses real CLI assistant/tool_use format"
```

---

### Task 7: Update `operations_spec.lua` — remove cancel tests, update mock

**Files:**
- Modify: `test/botglue/operations_spec.lua:187-199` (mock_claude), `327-397` (cancel tests)

**Step 1: Remove cancel from mock_claude**

In the `run` describe block's `before_each` (lines 187-198), update `mock_claude` to remove the `cancel` field. The mock should also return a handle from `start`:

Old:
```lua
      mock_claude = {
        start = function(prompt, ctx, observer)
          mock_claude._last_prompt = prompt
          mock_claude._last_ctx = ctx
          mock_claude._last_observer = observer
        end,
        cancel = function()
          mock_claude._cancelled = true
        end,
        _cancelled = false,
      }
```

New:
```lua
      mock_claude = {
        start = function(prompt, ctx, observer)
          mock_claude._last_prompt = prompt
          mock_claude._last_ctx = ctx
          mock_claude._last_observer = observer
          return { job_id = 1 }
        end,
      }
```

**Step 2: Delete the entire `cancel` describe block**

Delete lines 327-397 from `test/botglue/operations_spec.lua` (the entire `describe("cancel", ...)` block).

**Step 3: Run tests to verify all pass**

Run: `nvim --headless -u test/minimal_init.lua -c "PlenaryBustedFile test/botglue/operations_spec.lua"`

Expected: All remaining tests PASS (replace_selection, get_visual_selection, run).

**Step 4: Commit**

```bash
git add test/botglue/operations_spec.lua
git commit -m "test(operations): remove cancel tests, update claude mock to return handle"
```

---

### Task 8: Add parallel requests test

**Files:**
- Modify: `test/botglue/operations_spec.lua` (add test in `run` describe block)

**Step 1: Add the parallel requests test**

Add this test at the end of the `describe("run", ...)` block, after the "cleans up marks on completion" test:

```lua
    it("allows two parallel requests on different selections", function()
      local observers = {}
      local call_count = 0
      mock_claude.start = function(prompt, ctx, observer)
        call_count = call_count + 1
        table.insert(observers, { prompt = prompt, observer = observer })
        return { job_id = call_count }
      end

      local sel1 = {
        text = "line one",
        bufnr = bufnr,
        start_line = 1,
        start_col = 0,
        end_line = 1,
        end_col = 8,
      }
      local sel2 = {
        text = "line three",
        bufnr = bufnr,
        start_line = 3,
        start_col = 0,
        end_line = 3,
        end_col = 10,
      }

      operations.run("prompt A", "opus", sel1)
      operations.run("prompt B", "sonnet", sel2)

      assert.equals(2, call_count)

      -- Complete second request first (out of order)
      observers[2].observer.on_complete(nil, "new three")
      observers[1].observer.on_complete(nil, "new one")

      local lines = vim.api.nvim_buf_get_lines(bufnr, 0, -1, false)
      assert.equals("new one", lines[1])
      assert.equals("line two", lines[2])
      assert.equals("new three", lines[3])
    end)
```

**Step 2: Run tests to verify all pass**

Run: `nvim --headless -u test/minimal_init.lua -c "PlenaryBustedFile test/botglue/operations_spec.lua"`

Expected: All tests PASS including the new parallel test.

**Step 3: Commit**

```bash
git add test/botglue/operations_spec.lua
git commit -m "test(operations): add parallel requests test"
```

---

### Task 9: Run full validation

**Step 1: Run `make pr-ready`**

Run: `make pr-ready`

Expected output:
```
===> Linting
... (no errors)
===> Testing
... (all 57+ tests pass — we removed ~4 cancel tests but added ~3 new ones)
===> Checking format
... (no format issues)
===> All checks passed!
```

**Step 2: Fix any issues**

If luacheck or stylua reports issues, fix them. Common things to watch:
- Unused variables from removed cancel code
- Formatting inconsistencies from manual edits

**Step 3: Commit fixes if needed**

```bash
git add -A
git commit -m "chore: fix lint/format issues"
```

---

## Summary

| Task | What | Files |
|------|------|-------|
| 1 | Rewrite `_extract_result` tests | `test/botglue/claude_spec.lua` |
| 2 | Fix `_extract_result` implementation | `lua/botglue/claude.lua` |
| 3 | Remove cancel from `claude.lua` + test | `lua/botglue/claude.lua`, `test/botglue/claude_spec.lua` |
| 4 | Refactor `start()` to return handle | `lua/botglue/claude.lua` |
| 5 | Remove cancel from `operations.lua` + `init.lua` | `lua/botglue/operations.lua`, `lua/botglue/init.lua` |
| 6 | Fix `on_stdout` parsing | `lua/botglue/operations.lua` |
| 7 | Update operations tests, remove cancel tests | `test/botglue/operations_spec.lua` |
| 8 | Add parallel requests test | `test/botglue/operations_spec.lua` |
| 9 | Full validation with `make pr-ready` | all |
